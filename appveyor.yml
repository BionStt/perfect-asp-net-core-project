version: "1.0.{build}"
image: Visual Studio 2017
branches:
  only:
    - master
    - staging
    - production
for:
  - branches:
      only:
        - master
    build_script:
      - cmd: dotnet build
  - branches:
      only:
        - production
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      WEBSITE_PATH: production
    build_script:
      - cmd: dotnet publish -c Release -o ../release
    deploy_script:
      - cmd: dotnet run --project deploy/FtpDeployer.csproj ./release
  - branches:
      only:
        - staging
    environment:
      ASPNETCORE_ENVIRONMENT: Staging
      WEBSITE_PATH: staging
    build_script:
      - cmd: dotnet publish -c Release -o ../release
    artifacts:
      - path: ./release
        name: Release
        type: File
    deploy:
      provider: FTP
      protocol: ftp
      host: $(WEB_HOST)
      username: $(WEB_DEPLOYER_USERNAME)
      password: $(WEB_DEPLOYER_PASSWORD)
      folder: $(WEBSITE_PATH)
      artifact: Release
init:
  # Good practise, because Windows line endings are different from Unix/Linux ones
  - cmd: git config --global core.autocrlf true
install:
  - cmd: dotnet restore
clone_depth: 1
test_script:
  - cmd: dotnet test ./UnitTests
